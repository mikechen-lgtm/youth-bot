# 日期格式修正說明

**日期**：2026-01-28
**問題**：AI 回答時將日期轉換為「09月14日（日）」格式，沒有年份

## 問題分析

### 資料流程

```
資料庫工具 → AI → 用戶
    ✅           ❌
工具返回        AI轉換
2026/01/21    09月14日
```

### 問題根源

雖然資料庫工具返回的日期格式正確（包含年份），但 **AI 在生成回答時自行轉換了日期格式**，移除了年份。

**工具返回的格式（正確）**：
```json
{
  "publish_date": "2026/01/21 13:59",
  "time_range": {
    "from": "2026/01/28",
    "to": "2026/04/28",
    "description": "2026/01/28 到 2026/04/28（未來 90 天）"
  }
}
```

**AI 生成的回答（錯誤）**：
```
活動日期：09月14日（日）  ← 沒有年份！
```

## 解決方案

### 在系統提示詞中添加日期格式規則

**位置**：`app.py` → `_build_system_prompt()` → 活動查詢處理章節

**添加的規則**：

```
## 🔴 日期格式規則（嚴格遵守）

**工具返回的日期格式**：
- 活動日期：`2026/01/21 13:59` （YYYY/MM/DD HH:MM）
- 時間範圍：`2026/01/28 到 2026/04/28`

**回答時的強制要求**：
1. **必須**保持工具返回的原始格式
2. **嚴禁**轉換為其他格式（如：09月14日、1月21日）
3. **必須**包含完整年份（YYYY）

❌ 錯誤範例：「09月14日（日）」「1月21日」
✅ 正確範例：「2026/09/14」「2026/01/21 13:59」
```

### 添加回答範例

在「回答範例」章節添加活動查詢的正確範例：

```
Q: 最近有什麼活動？
A: 近期有以下活動：

1. 青年創業講座
   時間：2026/01/21 14:00        ← 包含年份
   主辦：桃園市政府青年事務局

2. 職涯探索工作坊
   時間：2026/02/15 10:00        ← 包含年份
   主辦：桃園青創事

詳細資訊可以到官方粉專查看。
```

## 修改內容

### 文件：`app.py`

**位置 1**：第 264-279 行（日期格式規則）
```python
## 🔴 日期格式規則（嚴格遵守）

**工具返回的日期格式**：
- 活動日期：`2026/01/21 13:59` （YYYY/MM/DD HH:MM）
- 時間範圍：`2026/01/28 到 2026/04/28`

**回答時的強制要求**：
1. **必須**保持工具返回的原始格式
2. **嚴禁**轉換為其他格式（如：09月14日、1月21日）
3. **必須**包含完整年份（YYYY）

❌ 錯誤範例：「09月14日（日）」「1月21日」
✅ 正確範例：「2026/09/14」「2026/01/21 13:59」
```

**位置 2**：第 320-334 行（回答範例）
```python
Q: 最近有什麼活動？
A: 近期有以下活動：

1. 青年創業講座
   時間：2026/01/21 14:00
   主辦：桃園市政府青年事務局

2. 職涯探索工作坊
   時間：2026/02/15 10:00
   主辦：桃園青創事

詳細資訊可以到官方粉專查看。
```

## 驗證

### 工具返回格式（已正確）

```bash
$ python3 -c "from database_tools import get_past_activities; \
result = get_past_activities(limit=1); \
print(result['activities'][0]['publish_date'])"

2026/01/21 13:59  ← 包含年份 ✅
```

### 系統提示詞（已添加規則）

```bash
$ python3 -c "from app import SYSTEM_PROMPT; \
print('日期格式規則' in SYSTEM_PROMPT)"

True  ← 已包含日期格式規則 ✅
```

### 後端狀態

```bash
$ ps aux | grep "python.*app.py" | grep -v grep

creativ+   51964  python3 app.py  ← 運行中 ✅
```

## 預期效果

### 修正前（錯誤）

```
用戶：最近有什麼活動？

AI：近期有以下活動：

1. 青年創業講座
   時間：09月14日（日）     ← 沒有年份 ❌

2. 職涯探索工作坊
   時間：1月21日           ← 沒有年份 ❌
```

### 修正後（正確）

```
用戶：最近有什麼活動？

AI：近期有以下活動：

1. 青年創業講座
   時間：2026/09/14 14:00  ← 有年份 ✅
   主辦：桃園市政府青年事務局

2. 職涯探索工作坊
   時間：2026/01/21 10:00  ← 有年份 ✅
   主辦：桃園青創事
```

## 關鍵要點

### ✅ 工具層面（已正確）

資料庫工具返回的所有日期都包含年份：
- `publish_date`: `2026/01/21 13:59`
- `time_range.from`: `2026/01/28`
- `time_range.to`: `2026/04/28`
- `time_range.description`: `2026/01/28 到 2026/04/28（未來 90 天）`

### 🔴 AI 層面（已修正）

通過系統提示詞明確要求：
1. ✅ 必須保持工具返回的原始日期格式
2. ✅ 嚴禁轉換為其他格式
3. ✅ 必須包含完整年份（YYYY）

### 📝 提示詞設計原則

當發現 AI 行為不符合預期時：
1. **檢查資料源** - 確認工具返回的資料格式
2. **檢查提示詞** - 是否有明確的格式要求
3. **添加範例** - 在回答範例中展示正確格式
4. **使用強調標記** - 🔴 紅色標記、**加粗**、❌/✅ 符號

## 相關文件

- [資料庫工具說明](DATABASE_TOOLS_GUIDE.md)
- [系統提示詞優化報告](SYSTEM_PROMPT_OPTIMIZATION.md)
- [工具簡化說明](TOOLS_SIMPLIFICATION.md)

## 總結

問題不在資料庫或工具層面，而在於 **AI 自行轉換了日期格式**。通過在系統提示詞中：
1. 添加明確的日期格式規則（🔴 標記強調）
2. 提供正確的回答範例
3. 列出錯誤和正確的對比

確保 AI 在回答時保持工具返回的原始日期格式，包含完整年份。
