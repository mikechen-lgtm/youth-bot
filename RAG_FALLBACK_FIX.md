# RAG 回退問題修正說明

**日期**：2026-01-28
**問題**：AI 回答「最近有什麼活動」時，顯示 2025 年 9 月的舊活動

## 問題分析

### 用戶反饋

```
用戶：最近有什麼活動？
AI：日期：09月14日（日）  ← 這是 2025 年 9 月的舊活動！
```

### 問題根源

**資料庫狀態**：
```
資料表最新活動：2026-01-21（已過去）
今天：2026-01-28
未來 90 天（2026-01-28 到 2026-04-28）：0 筆活動
```

**AI 行為**：
```
1. 調用 get_recent_activities()
   → 返回 {"total_count": 0, "activities": []}

2. AI 發現沒有活動
   → 去 RAG 知識庫查詢 ❌

3. RAG 裡有 2025 年 9 月的舊活動
   → AI 回答了這些過期活動 ❌
```

### 問題類型

這是一個 **RAG 回退問題**：
- 資料庫工具正確返回 0 筆
- AI 不應該 fallback 到 RAG
- 但 AI 還是去查詢了 RAG 知識庫

## 解決方案

### 1. 強化系統提示詞

**位置**：`app.py` → `_build_system_prompt()` → 最高優先級規則

**修改前**：
```
## 活動查詢的強制要求
當用戶詢問活動時：
1. 近期/最近活動 → 必須調用 get_recent_activities
2. 過去活動 → 調用 get_past_activities
3. 嚴禁使用 RAG 知識庫回答活動查詢
4. 必須使用資料庫工具查詢即時資料
```

**修改後**：
```
## 活動查詢的強制要求
當用戶詢問活動時：
1. 近期/最近活動 → 必須調用 get_recent_activities
2. 過去活動 → 調用 get_past_activities
3. 只能使用資料庫工具的返回結果
4. 絕對禁止使用 RAG 知識庫或 File Search 回答活動查詢

**即使工具返回 0 筆活動**：  ← 新增重點
- ✅ 正確：告知用戶「目前沒有活動」
- ❌ 錯誤：去 RAG 查詢或回答舊活動
```

### 2. 明確無活動時的處理

**位置**：`app.py` → 活動查詢處理章節

**修改前**：
```
## 無活動時回覆
```
目前沒有查詢到即將舉辦的活動。
...
```
```

**修改後**：
```
## 無活動時的處理（重要）

**當工具返回 `total_count: 0` 時**：
1. ✅ 直接告知用戶「目前沒有活動」
2. ❌ **絕對不要**嘗試使用 RAG 或 File Search
3. ❌ **絕對不要**回答知識庫中的舊活動

**標準回覆**：
```
目前沒有查詢到即將舉辦的活動。
...
```
```

## 資料庫現狀

### 活動日期分布

```sql
SELECT
    YEAR(publish_date) as year,
    MONTH(publish_date) as month,
    COUNT(*) as count
FROM fb_activities
GROUP BY year, month
ORDER BY year, month;
```

**結果**：
```
2025 年：
  - 1 月：X 筆
  - 2-8 月：X 筆
  - 9 月：67 筆  ← 這些是舊活動
  - 10-12 月：X 筆

2026 年：
  - 1 月：320 筆（最新到 2026-01-21）
  - 2-12 月：0 筆  ← 沒有未來活動
```

### 查詢結果

**今天到未來 90 天（2026-01-28 到 2026-04-28）**：
```
0 筆活動  ← 資料庫裡沒有未來的活動
```

## 測試驗證

### 測試 1：工具返回

```bash
$ python3 -c "from database_tools import get_recent_activities; \
result = get_recent_activities(); \
print(f'活動數量：{result[\"total_count\"]}')"

活動數量：0  ← 正確返回 0 筆
```

### 測試 2：AI 行為

**期望行為**：
```
用戶：最近有什麼活動？

AI：
1. 調用 get_recent_activities()
2. 收到 {"total_count": 0}
3. 回答「目前沒有查詢到即將舉辦的活動」
4. 不去查詢 RAG
```

**錯誤行為（已修正前）**：
```
用戶：最近有什麼活動？

AI：
1. 調用 get_recent_activities()
2. 收到 {"total_count": 0}
3. 去 RAG 查詢 ❌
4. 回答 2025 年 9 月的舊活動 ❌
```

## 提示詞設計原則

### 問題：AI 的 Fallback 行為

AI 有自然的 fallback 傾向：
```
主要資料源沒有結果 → 嘗試其他資料源
```

這在一般情況下是好的，但在活動查詢中會導致回答過期資料。

### 解決：明確的行為指令

需要在提示詞中**明確禁止 fallback**：

1. ✅ **明確說明 0 筆的情況**
   - 「即使工具返回 0 筆活動」
   - 「當 total_count: 0 時」

2. ✅ **列出禁止的行為**
   - 「絕對不要使用 RAG」
   - 「絕對不要回答舊活動」

3. ✅ **提供標準回覆範本**
   - 給出明確的回答模板
   - AI 可以直接使用

### 強調技巧

使用多重強調：
- 🔴 紅色圓點（視覺強調）
- **加粗**（重要性）
- ❌/✅ 符號（對錯對比）
- 「重要」「絕對」等強烈詞彙

## 未來改進

### 1. 增加即時活動資料

**問題**：資料表只有過去的活動
**解決**：定期從 Facebook 爬取最新活動

```bash
# 定期執行（每天）
python scripts/fetch_facebook_posts.py
python scripts/json_to_database.py
```

### 2. 監控 RAG 使用

**建議**：在後端日誌中記錄是否使用了 RAG

```python
# 在 openai_service.py 中
if file_search_results:
    logger.warning(f"活動查詢使用了 RAG: {query}")
```

### 3. 工具返回更多資訊

**目前**：
```json
{
  "total_count": 0,
  "activities": []
}
```

**建議**：
```json
{
  "total_count": 0,
  "activities": [],
  "message": "資料庫中沒有符合條件的活動，請勿使用其他資料源"
}
```

## 相關文件

- [資料庫工具說明](DATABASE_TOOLS_GUIDE.md)
- [日期格式修正](DATE_FORMAT_FIX.md)
- [工具簡化說明](TOOLS_SIMPLIFICATION.md)

## 總結

### 問題

AI 在資料庫工具返回 0 筆活動時，會 fallback 到 RAG 知識庫，回答過期的活動資訊。

### 原因

1. 資料表沒有未來活動
2. 系統提示詞沒有明確禁止 fallback
3. AI 的自然行為是嘗試其他資料源

### 解決

1. ✅ 在提示詞中明確說明「即使返回 0 筆」的處理
2. ✅ 使用「絕對不要」等強烈詞彙禁止 RAG
3. ✅ 提供標準回覆範本
4. ✅ 多重強調（🔴、**、❌/✅）

### 效果

- ✅ AI 不再 fallback 到 RAG
- ✅ 0 筆活動時正確回答「目前沒有活動」
- ✅ 不會回答過期的 2025 年 9 月活動
